<%- include('include/_adminHeader') -%>

<!-- Modals --->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeAddModal">&times;</span>
    <h2>Add New Blog</h2>
    <form id="addBlog">
      <div>
        <label for="title">Title: </label><br>
        <input type="text" id="title" name="title" />
      </div>
      <div>
        <label for="content">Content: </label><br>
        <textarea id="content" name="content" rows="6" cols="50"></textarea>
      </div>
      <div>
        <label for="date">Date: </label><br>
        <input type="date" id="date" name="date" />
      </div>
      <div>
        <label>Partner(s):</label><br>
        <div id="partner-selection">
          <% partners.forEach(function(partner) { %>
            <div class="partner-checkbox">
              <input type="checkbox" id="partner-<%= partner._id %>" value="<%= partner._id %>" />
              <label for="partner-<%= partner._id %>"><%= partner.name %></label>
            </div>
          <% }); %>
        </div>
      </div>
      <div>
        <label for="blogImageFile">Image File:</label><br>
        <input type="file" id="blogImageFile" accept="image/*" required />
        <input type="hidden" id="blogImageData" name="imageData" />
      </div>
      <button id="addBlogButton" type="submit">Add Blog</button>
    </form>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeEditModal">&times;</span>
    <h2>Edit Blog</h2>
    <form id="editBlog">
      <input type="hidden" id="editBlogId" name="blogId" />
      <div>
        <label for="editTitle">Title: </label><br>
        <input type="text" id="editTitle" name="title" />
      </div>
      <div>
        <label for="editContent">Content: </label><br>
        <textarea id="editContent" name="content" rows="6" cols="50"></textarea>
      </div>
      <div>
        <label for="editDate">Date: </label><br>
        <input type="date" id="editDate" name="date" />
      </div>
      <div>
        <label>Partner(s):</label><br>
        <div id="edit-partner-selection">
          <% partners.forEach(function(partner) { %>
            <div class="partner-checkbox">
              <input type="checkbox" id="edit-partner-<%= partner._id %>" value="<%= partner._id %>" />
              <label for="edit-partner-<%= partner._id %>"><%= partner.name %></label>
            </div>
          <% }); %>
        </div>
      </div>
      <div>
        <label for="editBlogImageFile">Image File:</label><br>
        <input type="file" id="editBlogImageFile" accept="image/*" />
        <input type="hidden" id="editBlogImageData" name="imageData" />
      </div>
      <button id="saveBlogButton" type="submit">Save Changes</button>
    </form>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeDeleteModal">&times;</span>
    <input type="hidden" id="deleteBlogId" />
    <h2>Delete Blog</h2>
    <p>Are you sure you want to delete this blog?</p>
    <button id="confirmDeleteButton">Yes, Delete</button>
    <button id="cancelDeleteButton">Cancel</button>
  </div>
</div>

<!--Main Content-->
<div class="container mt-4 text-center">
  <h1>Admin - Blogs</h1>
  <button id="openAddModal" class="btn btn-primary mb-3">Add New Blog</button>
    <div class="blog-grid">
    <% blogs.forEach(blog => { %>
      <article class="blog-card" data-id="<%= blog._id %>" data-title="<%= blog.title %>" data-content="<%= blog.content %>" data-date="<%= blog.date.toISOString().split('T')[0] %>" data-partners='<%= JSON.stringify(blog.partners) %>' data-image="<%= blog.image ? blog.image._id : '' %>">
        <% if (blog.image) { %>
          <img src="data:image/png;base64,<%= blog.image.imageData ? blog.image.imageData.toString('base64') : '' %>" alt="<%= blog.image.filename || 'Blog Image' %>" class="blog-image" />
        <% } else { %>
          <div class="blog-image-placeholder">No Image</div>
        <% } %>
        <div class="blog-content">
          <h3><%= blog.title %></h3>
          <p class="blog-snippet"><%= blog.content.length > 150 ? blog.content.substring(0, 150) + 'â€¦' : blog.content %></p>
          <div class="blog-meta">
            <span class="blog-date"><%= new Date(blog.date).toLocaleDateString('en-US', { timeZone: 'UTC', weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) %></span>
            <% if (blog.partners && blog.partners.length) { %>
              <div class="blog-partners">
                <% blog.partners.forEach(partner => { %>
                  <span class="blog-partner-tag"><%= partner.name || partner %></span>
                <% }) %>
              </div>
            <% } %>
          </div>
          <div class="blog-actions">
            <button class="btn btn-primary" onclick="editBlog('<%= blog._id %>')">Edit</button>
            <button class="btn btn-danger" onclick="deleteBlog('<%= blog._id %>')">Delete</button>
          </div>
        </div>
      </article>
    <% }); %>
  </div>
</div>

<script src="/js/blogs.js"></script>

